require("dotenv").config(); // ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å
const express = require("express");
const bodyParser = require("body-parser");
const admin = require("firebase-admin");
const axios = require("axios");
const cors = require("cors");

const app = express();
const PORT = process.env.PORT || 3000;

app.use(cors({
  origin: "https://warranty-register-53b10.web.app"
}));
app.use(bodyParser.json());

// üîê Firebase Admin Init ‡∏à‡∏≤‡∏Å Environment Variables (Base64)
const serviceAccount = JSON.parse(
  Buffer.from(process.env.FIREBASE_SERVICE_ACCOUNT_BASE64, "base64").toString("utf8")
);
admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
});
const db = admin.firestore();

const AFTERSHIP_API_KEY = process.env.AFTERSHIP_API_KEY; // ‡πÉ‡∏™‡πà‡πÉ‡∏ô .env
const AFTERSHIP_BASE_URL = "https://api.aftership.com/v4";

async function getTrackingInfo(slug, trackingNumber) {
  try {
    const response = await axios.get(
      `${AFTERSHIP_BASE_URL}/trackings/${slug}/${trackingNumber}`,
      {
        headers: {
          "aftership-api-key": AFTERSHIP_API_KEY,
          "Content-Type": "application/json",
        },
      }
    );

    const tracking = response.data.data.tracking;

    // üì¶ ‡∏Ñ‡∏∑‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Delivered ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    const deliveredDate = tracking?.delivered_at;
    return deliveredDate ? new Date(deliveredDate) : null;

  } catch (error) {
    console.error("‚ùå AfterShip API error:", error.response?.data || error.message);
    return null;
  }
}

// üîß ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏à‡∏≤‡∏Å AfterShip
async function getWarrantyFromTracking(slug, trackingNumber) {
  try {
    const res = await axios.get(`https://api.aftership.com/v4/trackings/${slug}/${trackingNumber}`, {
      headers: {
        "aftership-api-key": process.env.AFTERSHIP_API_KEY,
        "Content-Type": "application/json"
      }
    });

    const checkpoints = res.data?.data?.tracking?.checkpoints || [];
    const deliveredCheckpoint = checkpoints.find(cp => cp.tag === "Delivered");

    if (deliveredCheckpoint?.checkpoint_time) {
      const deliveredDate = new Date(deliveredCheckpoint.checkpoint_time);
      const warrantyUntil = new Date(deliveredDate);
      warrantyUntil.setDate(warrantyUntil.getDate() + 7);

      return { deliveredAt: deliveredDate, warrantyUntil };
    }
  } catch (err) {
    console.warn("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å AfterShip:", err.message);
  }

  return null; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
}



// ‚úÖ Helper
function calculateWarrantyUntil(days) {
  const today = new Date();
  today.setDate(today.getDate() + days);
  return today.toISOString().split("T")[0];
}

function formatDate(dateField) {
  try {
    return dateField.toDate().toISOString().split("T")[0];
  } catch {
    return "-";
  }
}

function createFlexMessage(data, orderData) {
  return {
    type: "flex",
    altText: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤",
    contents: {
      type: "bubble",
      size: "mega",
      header: {
        type: "box",
        layout: "vertical",
        contents: [
          {
            type: "text",
            text: "üì¶ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
            weight: "bold",
            size: "lg",
            color: "#1DB446"
          }
        ]
      },
      body: {
        type: "box",
        layout: "vertical",
        spacing: "sm",
        contents: [
          {
            type: "text",
            text: `‡∏ä‡∏∑‡πà‡∏≠: ${data.name}`,
            wrap: true
          },
          {
            type: "text",
            text: `‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${data.phone}`,
            wrap: true
          },
          {
            type: "text",
            text: `‡∏≠‡∏µ‡πÄ‡∏°‡∏•: ${data.email}`,
            wrap: true
          },
          {
            type: "text",
            text: `‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠: ${data.orderId}`,
            wrap: true
          },
          {
            type: "text",
            text: `‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: ${data.address}`,
            wrap: true
          },
          {
            type: "separator",
            margin: "md"
          },
          {
            type: "text",
            text: `üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: ${data.registeredAt}`,
            size: "sm",
            color: "#999999"
          },
          {
            type: "text",
            text: `üõ°Ô∏è ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ñ‡∏∂‡∏á: ${data.warrantyUntil}`,
            size: "sm",
            color: "#ff5555",
            weight: "bold"
          },
          ...(orderData?.items?.map((item, i) => ({
            type: "box",
            layout: "baseline",
            spacing: "sm",
            margin: "md",
            contents: [
              {
                type: "text",
                text: `‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${i + 1}:`,
                flex: 1,
                size: "sm"
              },
              {
                type: "text",
                text: `${item.productName} (${item.quantity})`,
                flex: 4,
                size: "sm",
                wrap: true
              }
            ]
          })) || [])
        ]
      },
      styles: {
        header: {
          backgroundColor: "#F0FDF4"
        }
      }
    }
  };
}


function createAdminClaimCard(claimId, orderId, reason, status, claimedAt, contact) {
  return {
    type: "flex",
    altText: `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏°: ${orderId}`,
    contents: {
      type: "bubble",
      size: "mega",
      body: {
        type: "box",
        layout: "vertical",
        spacing: "md",
        contents: [
          {
            type: "text",
            text: "üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Ñ‡∏•‡∏°",
            weight: "bold",
            size: "xl",
            color: "#1DB446"
          },
          {
            type: "separator",
            margin: "sm"
          },
          {
            type: "box",
            layout: "vertical",
            spacing: "sm",
            margin: "md",
            contents: [
              { type: "text", text: `üÜî ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠: ${orderId}`, size: "sm", wrap: true },
              { type: "text", text: `üë§ ‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á: ${contact}`, size: "sm", wrap: true },
              { type: "text", text: `üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á: ${claimedAt}`, size: "sm" },
              { type: "text", text: `üìå ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${reason}`, size: "sm", wrap: true },
              { type: "text", text: `üì¶ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${status}`, size: "sm", color: "#FF6F00" }
            ]
          }
        ]
      },
    
    }
  };
}


// ‚úÖ LIFF ID
app.get("/api/liff-id", (req, res) => {
  res.json({ liffId: process.env.LIFF_ID });
});

// ‚úÖ Save LINE user
app.post("/api/user", async (req, res) => {
  try {
    const { userId, displayName, pictureUrl } = req.body;
    if (!userId) return res.status(400).json({ message: "userId is required" });

    await db.collection("users").doc(userId).set({
      userId,
      displayName,
      pictureUrl,
      lastSeen: admin.firestore.Timestamp.now()
    }, { merge: true });

    res.status(200).json({ message: "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢" });
  } catch (error) {
    console.error("‚ùå Error saving user profile:", error);
    res.status(500).json({ message: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ" });
  }
});

// ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
app.get("/api/order/:orderId", async (req, res) => {
  try {
    const orderId = req.params.orderId;

    // üîç ‡πÄ‡∏ä‡πá‡∏Å‡πÉ‡∏ô Shopee
    let orderDoc = await db.collection("orders").doc(orderId).get();
    if (orderDoc.exists) {
      const data = orderDoc.data();
      data.purchaseDateFormatted = formatDate(data.purchaseDate);
      return res.status(200).json({ ...data, source: "shopee" });
    }

    // üîç ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡∏•‡∏≠‡∏á‡πÉ‡∏ô TikTok
    orderDoc = await db.collection("orders_tiktok").doc(orderId).get();
    if (orderDoc.exists) {
      const data = orderDoc.data();
      data.purchaseDateFormatted = formatDate(data.purchaseDate);
      return res.status(200).json({ ...data, source: "tiktok" });
    }

    return res.status(404).json({ message: "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠" });
  } catch (error) {
    console.error("‚ùå Error fetching order:", error);
    return res.status(500).json({ message: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠" });
  }
});


// ‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
app.post("/api/register", async (req, res) => {
  try {
    const { userId, name, phone, email, orderId, address } = req.body;

    const existing = await db.collection("registrations").doc(orderId).get();
    if (existing.exists) {
      return res.status(400).json({ message: "üîÅ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß" });
    }

    // üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ order ‡∏à‡∏≤‡∏Å Shopee ‡∏´‡∏£‡∏∑‡∏≠ TikTok
    let orderDoc = await db.collection("orders").doc(orderId).get();
    let source = "shopee";

    if (!orderDoc.exists) {
      orderDoc = await db.collection("orders_tiktok").doc(orderId).get();
      source = "tiktok";
    }

    if (!orderDoc.exists) {
      return res.status(404).json({ message: "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠" });
    }

    const orderData = orderDoc.data();

    // üì¶ ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏à‡∏≤‡∏Å AfterShip
    let warrantyUntil = null;
    let deliveredAt = null;

    if (orderData.trackingNumber && orderData.slug) {
      const result = await getWarrantyFromTracking(orderData.slug, orderData.trackingNumber);
      if (result) {
        deliveredAt = result.deliveredAt;
        warrantyUntil = result.warrantyUntil;
      }
    }

    // üîÅ fallback ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ tracking info ‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î default 7 ‡∏ß‡∏±‡∏ô
    if (!warrantyUntil) {
      const fallback = new Date();
      fallback.setDate(fallback.getDate() + 7);
      warrantyUntil = fallback;
    }

    const registeredAt = new Date();

    // üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firestore
    await db.collection("registrations").doc(orderId).set({
      userId,
      name,
      phone,
      email,
      orderId,
      address,
      registeredAt: admin.firestore.Timestamp.fromDate(registeredAt),
      warrantyUntil: admin.firestore.Timestamp.fromDate(warrantyUntil),
      deliveredAt: deliveredAt ? admin.firestore.Timestamp.fromDate(deliveredAt) : null, // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
      source,
    });

    // ‚úâÔ∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message
    const flexMessage = createFlexMessage({
      userId,
      name,
      phone,
      email,
      orderId,
      address,
      registeredAt: registeredAt.toISOString().split("T")[0],
      warrantyUntil: warrantyUntil.toISOString().split("T")[0],
    }, orderData);

    // üì§ ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö LINE
    await axios.post("https://api.line.me/v2/bot/message/push", {
      to: userId,
      messages: [flexMessage],
    }, {
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${process.env.LINE_CHANNEL_ACCESS_TOKEN}`
      }
    });

    res.status(200).json({ message: "‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" });
  } catch (error) {
    console.error("‚ùå Error on /api/register:", error);
    res.status(500).json({ message: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö" });
  }
});



// ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏•‡∏°
app.get("/api/check-status/:orderId", async (req, res) => {
  try {
    const orderId = req.params.orderId;

    console.log("üîç ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ orderId:", orderId);

    const regDoc = await db.collection("registrations").doc(orderId).get();

    console.log("üì¶ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö registration:", orderId, "=> exists:", regDoc.exists);

    const claimsQuery = await db.collection("claims")
      .where("orderId", "==", orderId)
      .orderBy("claimedAt", "desc")
      .get();

    const registration = regDoc.exists ? regDoc.data() : null;
    const claims = [];
    claimsQuery.forEach(doc => {
      claims.push({ id: doc.id, ...doc.data() });
    });

    if (!registration && claims.length === 0) {
      return res.status(404).json({ message: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" });
    }

    return res.status(200).json({ registration, claims });
  } catch (error) {
    console.error("‚ùå Error on /api/check-status:", error);
    return res.status(500).json({ message: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö" });
  }
});


// ‚úÖ ‡πÄ‡∏Ñ‡∏•‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
// ‚úÖ ‡πÄ‡∏Ñ‡∏•‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
app.post("/api/claim", async (req, res) => {
  try {
    const { userId, orderId, reason, contact } = req.body;
    if (!userId || !orderId || !reason || !contact) {
      return res.status(400).json({ message: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô" });
    }

    // üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ order ‡∏à‡∏≤‡∏Å Shopee ‡∏´‡∏£‡∏∑‡∏≠ TikTok
    let orderDoc = await db.collection("orders").doc(orderId).get();
    if (!orderDoc.exists) {
      orderDoc = await db.collection("orders_tiktok").doc(orderId).get();
    }
    if (!orderDoc.exists) {
      return res.status(404).json({ message: "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠" });
    }

    const orderData = orderDoc.data(); // ‚úÖ ‡πÉ‡∏ä‡πâ orderData ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πà‡∏≤‡∏ô source

    // üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
    const regDoc = await db.collection("registrations").doc(orderId).get();
    if (!regDoc.exists) {
      return res.status(400).json({ message: "‚õî ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ" });
    }

    const regData = regDoc.data();
    const warrantyUntil = new Date(regData.warrantyUntil);
    const today = new Date();

    if (today > warrantyUntil) {
      return res.status(400).json({ message: `‚ö†Ô∏è ‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${regData.warrantyUntil}` });
    }

    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° source ‡∏•‡∏á claims
  await db.collection("claims").add({
  userId,
  orderId,
  reason,
  contact,
  status: "‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£",
  claimedAt: admin.firestore.Timestamp.now(),
  source: orderData.source || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏",

  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
  name: regData.name || "-",
  email: regData.email || "-",
  phone: regData.phone || "-",
  address: regData.address || "-",
  registeredAt: regData.registeredAt || null,
  warrantyUntil: regData.warrantyUntil || "-"
});


    // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    const newClaimQuery = await db.collection("claims")
      .where("userId", "==", userId)
      .where("orderId", "==", orderId)
      .orderBy("claimedAt", "desc")
      .limit(1)
      .get();

    if (!newClaimQuery.empty) {
      const claimDoc = newClaimQuery.docs[0];
      const claimId = newClaimQuery.docs[0].id;
      const claimData = claimDoc.data();
      const claimedAtStr = claimData.claimedAt.toDate().toISOString().split("T")[0];

      const adminFlex = createAdminClaimCard(claimId, orderId, reason, "‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£", claimedAtStr, contact);
      // ‚ùå ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏´‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß)
    }

    // ‚úÖ ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ú‡πà‡∏≤‡∏ô LINE
    const messages = [
      {
        type: "text",
        text: `üì¢ ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Ñ‡∏•‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß\n‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠: ${orderId}\n‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${reason}\n‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 1-2 ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£`
      },
      {
        type: "flex",
        altText: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏ä‡∏ó‡∏ô‡∏µ‡πâ",
        contents: {
          type: "bubble",
          body: {
            type: "box",
            layout: "vertical",
            contents: [
              { type: "text", text: "üì∑ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏°", weight: "bold", wrap: true },
              { type: "text", text: "‡πÄ‡∏ä‡πà‡∏ô:\n‚Ä¢ ‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤\n‚Ä¢ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤\n‚Ä¢ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à\n‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏ä‡∏ó‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö", size: "sm", wrap: true }
            ]
          }
        }
      }
    ];

    await axios.post("https://api.line.me/v2/bot/message/push", {
      to: userId,
      messages
    }, {
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${process.env.LINE_CHANNEL_ACCESS_TOKEN}`
      }
    });

    res.status(200).json({ message: "‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏Ñ‡∏•‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" });
  } catch (error) {
    console.error("‚ùå Error on /api/claim:", error);
    res.status(500).json({ message: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Ñ‡∏•‡∏°" });
  }
});


app.get("/api/claims", async (req, res) => {
  try {
    const snapshot = await db.collection("claims").orderBy("claimedAt", "desc").get();
    const claims = snapshot.docs.map(doc => {
      const data = doc.data();
      return {
        id: doc.id,
        ...data,
        claimedAtFormatted: formatDate(data.claimedAt)
      };
    });
    res.json({ claims });
  } catch (err) {
    res.status(500).json({ message: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏°" });
  }
});


app.patch("/api/claims/:id/status", async (req, res) => {
  const { id } = req.params;
  const { status } = req.body;

  console.log("üì¶ PATCH /api/claims/:id/status", { id, status });

  try {
    const docRef = db.collection("claims").doc(id);
    const docSnap = await docRef.get();

    if (!docSnap.exists) {
      return res.status(404).json({ message: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏°‡∏ô‡∏µ‡πâ" });
    }

    await docRef.update({ status });
    res.json({ message: "‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢" });
  } catch (err) {
    console.error("‚ùå PATCH status error:", err);
    res.status(500).json({ message: "‚ùå ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" });
  }
});


app.get("/api/registrations", async (req, res) => {
  try {
    const snapshot = await db.collection("registrations").orderBy("registeredAt", "desc").get();
    const registrations = snapshot.docs.map(doc => {
      const data = doc.data();
      return {
        id: doc.id,
        ...data,
        registeredAtFormatted: formatDate(data.registeredAt)
      };
    });
    res.json({ registrations });
  } catch (err) {
    res.status(500).json({ message: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô" });
  }
});


app.delete("/api/claims/:id", async (req, res) => {
  try {
    await db.collection("claims").doc(req.params.id).delete();
    res.json({ message: "‚úÖ ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" });
  } catch (err) {
    res.status(500).json({ message: "‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" });
  }
});

app.delete("/api/registrations/:orderId", async (req, res) => {
  try {
    await db.collection("registrations").doc(req.params.orderId).delete();
    res.json({ message: "‚úÖ ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" });
  } catch (err) {
    res.status(500).json({ message: "‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" });
  }
});



// ‚úÖ API ‡∏™‡πà‡∏á firebaseConfig ‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà key ‡∏•‡∏±‡∏ö)
app.get("/api/firebase-config", (req, res) => {
  res.json({
    apiKey: process.env.FIREBASE_API_KEY,
    authDomain: process.env.FIREBASE_AUTH_DOMAIN,
    projectId: process.env.FIREBASE_PROJECT_ID,
    storageBucket: process.env.FIREBASE_STORAGE_BUCKET,
    messagingSenderId: process.env.FIREBASE_MESSAGING_SENDER_ID,
    appId: process.env.FIREBASE_APP_ID
  });
});

const multer = require("multer");
const XLSX = require("xlsx");
const upload = multer({ storage: multer.memoryStorage() });

function parseExcelDate(value) {
  if (!value) return null;

  if (typeof value === "number") {
    return new Date(Math.round((value - 25569) * 86400 * 1000));
  }

  if (typeof value === "string" && /^\d{4}-\d{2}-\d{2} \d{2}:\d{2}$/.test(value)) {
    const iso = value.replace(" ", "T") + ":00"; // ‚ûú ISO format
    return new Date(iso);
  }

  const parsed = new Date(value);
  return isNaN(parsed.getTime()) ? null : parsed;
}

function mapShippingProviderToSlug(name) {
  const normalized = name.toLowerCase().trim();

  if (normalized.includes("flash")) return "flash-express";
  if (normalized.includes("spx")) return "spx";
  if (normalized.includes("kerry")) return "kerry-express";
  if (normalized.includes("j&t")) return "jtexpress";
  if (normalized.includes("j&t express")) return "jtexpress";
  if (normalized.includes("ninja")) return "ninjavan";
  if (normalized.includes("best")) return "best-express";
  if (normalized.includes("‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå") || normalized.includes("post")) return "thailand-post";

  return "unknown";
}


app.post("/api/upload-orders", upload.single("file"), async (req, res) => {
  try {
    const buffer = req.file.buffer;
    const workbook = XLSX.read(buffer, { type: "buffer" });
    const sheetName = workbook.SheetNames[0];
    const data = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

    let added = 0;
    let skipped = 0;

    function extractSlugFromShopee(shippingOption) {
      if (!shippingOption) return null;
      if (shippingOption.includes("Flash")) return "flash";
      if (shippingOption.includes("SPX")) return "spx";
      if (shippingOption.includes("J&T")) return "jnt-express";
      return null;
    }

    for (const row of data) {
      const orderId = row["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠"];
      if (!orderId) continue;

      const orderRef = db.collection("orders").doc(orderId);
      const existing = await orderRef.get();

      const trackingNumber = row["*‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏û‡∏±‡∏™‡∏î‡∏∏"]?.toString().trim() || "";
      const shippingOption = row["‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á"] || "";
      const slug = extractSlugFromShopee(shippingOption);

      const item = {
        productName: row["‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"] || "",
        quantity: row["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"] || 1,
        sku: row["‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á SKU (SKU Reference No.)"] || "",
        price: row["‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢"] || 0,
      };

      if (existing.exists) {
        await orderRef.update({
          items: admin.firestore.FieldValue.arrayUnion(item)
        });
        skipped++;
        continue;
      }

      await orderRef.set({
        orderId,
        name: row["‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö"] || "",
        status: row["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠"] || "",
        purchaseDate: parseExcelDate(row["‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"]),
        items: [item],
        trackingNumber,
        slug,
        source: "shopee",
        createdAt: admin.firestore.FieldValue.serverTimestamp()
      });

      added++;
    }

    res.status(200).json({
      message: `‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß ${added} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£, ‚è© ‡∏Ç‡πâ‡∏≤‡∏° ${skipped} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ã‡πâ‡∏≥)`
    });
  } catch (error) {
    console.error("‚ùå Error uploading orders:", error);
    res.status(500).json({ message: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠" });
  }
});



// ‚úÖ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏•‡∏°‡∏ú‡πà‡∏≤‡∏ô Flex Message
app.post("/api/notify-status-change", async (req, res) => {
  try {
    const { claimId, status } = req.body;

    const claimDoc = await db.collection("claims").doc(claimId).get();
    if (!claimDoc.exists) {
      return res.status(404).json({ message: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏°" });
    }

    const claimData = claimDoc.data();
    const { userId, orderId, reason, claimedAt, contact } = claimData;

    const claimedAtStr = claimedAt.toDate().toISOString().split("T")[0];

    const flex = createAdminClaimCard(claimId, orderId, reason, status, claimedAtStr, contact);

    await axios.post("https://api.line.me/v2/bot/message/push", {
      to: userId,
      messages: [
        {
          type: "text",
          text: `üì¢ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏õ‡πá‡∏ô: ${status}`
        },
        flex
      ]
    }, {
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${process.env.LINE_CHANNEL_ACCESS_TOKEN}`
      }
    });

    res.status(200).json({ message: "üì§ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" });
  } catch (err) {
    console.error("‚ùå Error on /api/notify-status-change:", err);
    res.status(500).json({ message: "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ" });
  }
});

app.get("/api/registrations/:orderId", async (req, res) => {
  const { orderId } = req.params;
  try {
    const doc = await db.collection("registrations").doc(orderId).get();
    if (doc.exists) {
      res.json({ registered: true, data: doc.data() });
    } else {
      res.json({ registered: false });
    }
  } catch (err) {
    res.status(500).json({ error: "Server error" });
  }
});

// ‚úÖ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ register
app.get("/api/liff-id-register", (req, res) => {
  res.json({ liffId: process.env.LIFF_ID_REGISTER });
});

// ‚úÖ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ claim
app.post("/api/upload-orders-tiktok", upload.single("file"), async (req, res) => {
  try {
    if (!req.file) return res.status(400).json({ message: "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå" });

    const workbook = XLSX.read(req.file.buffer, { type: "buffer" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { defval: "", raw: false });

    const batch = db.batch();
    let successCount = 0;

    const slugMap = {
      "J&T Express": "jnt-express",
      "Flash Express": "flash",
      "SPX Express": "spx"
    };

    rows.forEach((row) => {
      const orderId = row["Order ID"]?.toString().trim();
      if (orderId === "Platform unique order ID." || !orderId) return;

      const name = row["Recipient"]?.toString().trim() || "-";
      const productName = row["Product Name"]?.toString().trim() || "-";
      const status = row["Order Status"]?.toString().trim() || "-";
      const trackingNumber = row["Tracking ID"]?.toString().trim() || "";
      const slug = slugMap[row["Shipping Provider Name"]] || null;

      // üîÑ ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
      let purchaseDate = null;
      try {
        const raw = row["Paid Time"];
        let date = null;
        if (typeof raw === "number") {
          date = new Date((raw - 25569) * 86400 * 1000);
        } else if (typeof raw === "string") {
          if (raw.includes("/")) {
            const [d, m, yAndTime] = raw.split("/");
            const [y, time] = yAndTime.split(" ");
            date = new Date(`${y}-${m.padStart(2, "0")}-${d.padStart(2, "0")}T${time}`);
          } else {
            date = new Date(raw.replace(" ", "T"));
          }
        }
        if (date && !isNaN(date)) {
          purchaseDate = admin.firestore.Timestamp.fromDate(date);
        }
      } catch (err) {
        console.warn("‚ö†Ô∏è ‡πÅ‡∏õ‡∏•‡∏á Paid Time ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:", row["Paid Time"]);
      }

      const ref = db.collection("orders_tiktok").doc(orderId);
      batch.set(ref, {
        orderId,
        name,
        status,
        trackingNumber,
        slug,
        purchaseDate,
        items: [
          {
            productName,
            quantity: parseInt(row["Quantity"]) || 1,
          },
        ],
        source: "tiktok",
        createdAt: admin.firestore.FieldValue.serverTimestamp(),
      }, { merge: true });

      successCount++;
    });

    await batch.commit();
    res.json({
      message: `‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚úÖ`,
    });
  } catch (err) {
    console.error("‚õî Upload TikTok Error:", err);
    res.status(500).json({ message: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î TikTok" });
  }
});


app.post("/api/check-delivery-date", async (req, res) => {
  const { orderId, source } = req.body;
  const collection = source === "tiktok" ? "orders_tiktok" : "orders";
  const orderRef = db.collection(collection).doc(orderId);
  const orderDoc = await orderRef.get();

  if (!orderDoc.exists) {
    return res.status(404).json({ message: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠" });
  }

  const data = orderDoc.data();
  const { trackingNumber, slug } = data;

  if (!trackingNumber || !slug || slug === "unknown") {
    return res.status(400).json({ message: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏ô‡∏™‡πà‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö" });
  }

  const deliveredDate = await getTrackingInfo(slug, trackingNumber);

  if (!deliveredDate) {
    return res.status(404).json({ message: "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" });
  }

  // üßÆ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 365 ‡∏ß‡∏±‡∏ô)
  const warrantyUntil = new Date(deliveredDate);
  warrantyUntil.setDate(warrantyUntil.getDate() + 365);

  await orderRef.update({
    deliveredDate: admin.firestore.Timestamp.fromDate(deliveredDate),
    warrantyUntil: admin.firestore.Timestamp.fromDate(warrantyUntil),
  });

  res.json({
    message: "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ",
    deliveredDate,
    warrantyUntil,
  });
});



//fihfrrji
// ‚úÖ Start Server
app.listen(PORT, () => {
  console.log(`üöÄ Server is running on http://localhost:${PORT}`);
});
