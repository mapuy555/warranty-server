<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Prompt', sans-serif;
      max-width: 400px;
      margin: 30px auto;
      padding: 20px;
      background-color: #f9f9f9;
      border-radius: 12px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; }
    .box { background: white; padding: 15px; border-radius: 10px; }
    .box p { margin: 6px 0; }
    button {
       font-family: 'Prompt', sans-serif;
      width: 100%;
      margin-top: 12px;
      padding: 10px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #confirmBtn { background-color: #ff8800; color: white; }
    #editBtn { background-color: #ccc; }
    .error, .success { text-align: center; margin-top: 10px; font-size: 14px; }
  </style>
</head>
<body>
  <h2>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏°</h2>
  <div class="box">
    <p><strong>‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠:</strong> <span id="orderId"></span></p>
    <p><strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</strong> <span id="reason"></span></p>
    <p><strong>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:</strong> <span id="contact"></span></p>
    <hr />
    <p><strong>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</strong></p>
    <ul id="productList" style="padding-left: 20px;"></ul>
  </div>

  <button id="confirmBtn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏°</button>
  <button id="editBtn">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
  <p class="error" id="errorMsg"></p>
  <p class="success" id="successMsg"></p>

  <script>
    const apiBase = "https://warranty-api-umg2.onrender.com";
    const params = new URLSearchParams(window.location.search);
    const errorMsg = document.getElementById("errorMsg");
    const successMsg = document.getElementById("successMsg");
    let data = null;

    try {
      data = JSON.parse(decodeURIComponent(params.get("data")));
    } catch {
      errorMsg.textContent = "‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà";
      document.getElementById("confirmBtn").disabled = true;
    }

    document.getElementById("orderId").textContent = data.orderId;
    document.getElementById("reason").textContent = data.reason;
    document.getElementById("contact").textContent = data.contact;

    async function fetchItems(orderId) {
      try {
        const res = await fetch(`${apiBase}/api/registrations/${orderId}`);
        if (!res.ok) throw new Error();
       const reg = await res.json();
console.log("üì¶ ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å API:", reg);

const items = reg.data?.items || reg.items || [];
const productList = document.getElementById("productList");
productList.innerHTML = Array.isArray(items) && items.length
  ? items.map(item => {
      if (typeof item === "object") {
        return `<li>‚Ä¢ ${item.productName || "-"} (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${item.quantity || 1})</li>`;
      } else {
        return `<li>‚Ä¢ ${item}</li>`;
      }
    }).join("")
  : "<li>‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</li>";



      } catch {
        document.getElementById("productList").innerHTML = "<li>‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</li>";
      }
    }

    fetchItems(data.orderId);

    document.getElementById("confirmBtn").addEventListener("click", async () => {
      errorMsg.textContent = "";
      successMsg.textContent = "";

      try {
        const res = await fetch(`${apiBase}/api/claim`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        const result = await res.json();
        if (res.ok) {
          successMsg.textContent = result.message || "üì¶ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Ñ‡∏•‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
          setTimeout(() => liff?.closeWindow(), 2000);
        } else {
          errorMsg.textContent = result.message || "‚ùå ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Ñ‡∏•‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
        }
      } catch {
        errorMsg.textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå";
      }
    });

    document.getElementById("editBtn").addEventListener("click", () => {
      history.back();
    });
  </script>
</body>
</html>
