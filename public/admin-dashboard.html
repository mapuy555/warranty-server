<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --admin-red: #e11d48;
      --admin-black: #1f2937;
      --admin-green: #2563eb;
      --admin-light: #f3f4f6;   
    }
    body {
         font-family: 'Prompt', sans-serif;
         background-color: #f9fafb;
      }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-[var(--admin-light)] text-gray-800">
  <!-- üîù Navbar -->
  <nav class="bg-[var(--admin-green)] text-white px-6 py-3 w-full flex flex-wrap justify-between items-center gap-2 shadow-md">
  <div class="text-lg font-semibold mb-2 md:mb-0">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</div>
  <div class="flex flex-wrap items-center gap-3 text-sm">
    <a href="admin-dashboard.html" class="bg-white text-[var(--admin-green)] font-medium px-3 py-1 rounded-md shadow hover:bg-[var(--admin-light)] transition">Dashboard</a>
    <a href="admin-claims.html" class="hover:text-[var(--admin-black)]">‡πÄ‡∏Ñ‡∏•‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a>
    <a href="admin-registrations.html" class="hover:text-[var(--admin-black)]">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</a>
    <a href="admin-upload.html" class="bg-white text-[#ee4d2d] border border-[#ee4d2d] hover:bg-[#ee4d2d] hover:text-white px-3 py-1 rounded-md shadow transition">Shopee</a>
    <a href="admin-upload-tiktok.html" class="bg-white text-black border border-gray-400 hover:bg-[#121212] hover:text-white px-3 py-1 rounded-md shadow transition">TikTok</a>

    <!-- ‚úÖ ‡∏¢‡πâ‡∏≤‡∏¢ admin-info ‡∏°‡∏≤‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢ -->
    <div id="admin-info" class="ml-3"></div>
  </div>
</nav>



 <!-- üßæ Main -->
  <main class="max-w-7xl mx-auto py-6 px-4">
    

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- ‚úÖ Registration Table -->
      <section class="bg-white p-5 rounded-xl shadow">
        <h2 class="text-lg font-semibold text-[var(--admin-green)] mb-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
        <input type="text" id="searchRegistration" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Order ID, ‡∏ä‡∏∑‡πà‡∏≠, ‡πÄ‡∏ö‡∏≠‡∏£‡πå..." class="mb-3 w-full border border-gray-300 px-3 py-2 rounded focus:ring focus:ring-blue-200">
        <div class="overflow-x-auto max-h-[420px] overflow-y-auto border border-gray-200 rounded-md">
          <table class="w-full text-sm text-left min-w-[600px]">
            <thead class="bg-gray-100 sticky top-0 z-10">
              <tr>
                <th class="border px-2 py-2">Order ID</th>
                <th class="border px-2 py-2">‡∏ä‡∏∑‡πà‡∏≠</th>
                <th class="border px-2 py-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
                <th class="border px-2 py-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                <th class="border px-2 py-2">‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</th>
                <th class="border px-2 py-2">‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤</th>
                <th class="border px-2 py-2 text-center">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                <th class="border px-2 py-2 text-center">‡∏•‡∏ö</th>
              </tr>
            </thead>
            <tbody id="registrationTable"></tbody>
          </table>
        </div>
      </section>

      <!-- üìù Claim Table -->
      <section class="bg-white p-5 rounded-xl shadow">
        <h2 class="text-lg font-semibold text-[var(--admin-green)] mb-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Ñ‡∏•‡∏°</h2>
        <input type="text" id="searchClaim" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Order ID, ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•..." class="mb-3 w-full border border-gray-300 px-3 py-2 rounded focus:ring focus:ring-blue-200">
        <div class="overflow-x-auto max-h-[420px] overflow-y-auto border border-gray-200 rounded-md">
          <table class="w-full text-sm text-left min-w-[700px]">
            <thead class="bg-gray-100 sticky top-0 z-10">
              <tr>
                <th class="border px-2 py-2">Order ID</th>
                <th class="border px-2 py-2">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</th>
                <th class="border px-2 py-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th class="border px-2 py-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                <th class="border px-2 py-2">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th class="border px-2 py-2">‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤</th>
                <th class="border px-2 py-2 text-center">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                <th class="border px-2 py-2 text-center">‡∏•‡∏ö</th>
              </tr>
            </thead>
            <tbody id="claimTable"></tbody>
          </table>
        </div>
      </section>
    </div>

    <p id="status" class="mt-4 text-center text-green-600 font-medium"></p>
  </main>


    <p id="status" class="mt-4 text-center text-blue-600"></p>
  </div>

  <!-- üîç Modal ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î -->
  <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-lg relative">
      <button onclick="closeModal()" class="absolute top-2 right-3 text-gray-500 hover:text-red-500 text-xl">‚úñ</button>
      <h3 class="text-lg font-semibold mb-4 text-[var(--admin-green)]">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h3>
      <div id="modalContent" class="text-sm space-y-2"></div>
    </div>
  </div>

  <!-- üì§ Export Button -->
  <div class="fixed bottom-4 right-4">
    <button onclick="exportToExcel()" class="bg-[var(--admin-red)] hover:bg-[var(--admin-green)] text-white px-5 py-2 rounded shadow transition">Export Excel</button>
  </div>

 
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

  const firebaseRes = await fetch("https://warranty-api-umg2.onrender.com/api/firebase-config");
  const firebaseConfig = await firebaseRes.json();
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const allowedAdmins = ["suphatraprayurkha@gmail.com"];

  let registrationData = [], claimData = [];

  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = "admin-login.html";
    } else if (!allowedAdmins.includes(user.email)) {
      alert("‚õî ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ");
      signOut(auth);
    } else {
     document.getElementById("admin-info").innerHTML = `
  <div class="flex items-center gap-2 bg-white text-gray-800 px-3 py-1 rounded-md shadow text-xs">
    <i class="fas fa-user-circle text-lg text-gray-600"></i>
    <span class="hidden sm:inline">${user.email}</span>
    <button onclick="logout()" class="text-red-600 hover:text-white hover:bg-red-600 transition px-2 py-0.5 rounded">‡∏≠‡∏≠‡∏Å</button>
  </div>
`;




      loadRegistrations();
      loadClaims();
    }
  });

  window.logout = () => signOut(auth);

 async function loadRegistrations() {
  const res = await fetch("https://warranty-api-umg2.onrender.com/api/registrations");
  const data = await res.json();

  registrationData = data.registrations.map(r => ({
    ...r,
    registeredAtFormatted: formatDate(r.registeredAt)
  }));

  renderRegistrationTable();
}


  async function loadClaims() {
    const res = await fetch("https://warranty-api-umg2.onrender.com/api/claims");
    const data = await res.json();
    claimData = data.claims;
    renderClaimTable();
  }

function formatDate(ts) {
  try {
    if (!ts) return "-";

    if (typeof ts === "string") {
      const date = new Date(ts);
      return isNaN(date.getTime()) ? "-" : date.toISOString().split("T")[0];
    }

    if (typeof ts === "object") {
      // ‚úÖ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Firestore Timestamp ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ seconds/nanoseconds
      if ("_seconds" in ts || "seconds" in ts) {
        const seconds = ts.seconds || ts._seconds;
        return new Date(seconds * 1000).toISOString().split("T")[0];
      }

      if (typeof ts.toDate === "function") {
        return ts.toDate().toISOString().split("T")[0];
      }
    }

    return "-";
  } catch {
    return "-";
  }
}


function renderSource(source) {
  if (source === "tiktok") {
    return `<span class="bg-black text-white text-xs px-2 py-0.5 rounded">TikTok</span>`;
  } else if (source === "shopee") {
    return `<span class="bg-orange-500 text-white text-xs px-2 py-0.5 rounded">Shopee</span>`;
  } else {
    return `<span class="bg-gray-300 text-gray-700 text-xs px-2 py-0.5 rounded">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</span>`;
  }
}





  function renderRegistrationTable() {
    const keyword = document.getElementById("searchRegistration").value.toLowerCase();
    const table = document.getElementById("registrationTable");
    table.innerHTML = "";
    registrationData.filter(r =>
      r.orderId.toLowerCase().includes(keyword) ||
      (r.name && r.name.toLowerCase().includes(keyword)) ||
      (r.phone && r.phone.includes(keyword))
    ).forEach(item => {
      table.innerHTML += `
        <tr>
          <td class="border px-2 py-1">${item.orderId}</td>
          <td class="border px-2 py-1">${item.name || "-"}</td>
          <td class="border px-2 py-1">${item.phone || "-"}</td>
          
          <td class="border px-2 py-1">${item.registeredAtFormatted || "-"}</td>

          <td class="border px-2 py-1">${item.warrantyUntil || "-"}</td>
          <td class="border px-2 py-1">${renderSource(item.source)}</td>

          <td class="border px-2 py-1 text-center">
  <button onclick='showDetail(${JSON.stringify(item).replace(/"/g, '&quot;')})' class="text-blue-600 hover:text-blue-800 text-lg">
    <i class="fas fa-eye"></i>
  </button>
</td>
<td class="border px-2 py-1 text-center">
  <button onclick="deleteClaim('${item.id}')" class="text-red-600 hover:text-red-800 text-lg">
    <i class="fas fa-trash-alt"></i>
  </button>
</td>

        </tr>`;
    });
  }

  function renderClaimTable() {
    const keyword = document.getElementById("searchClaim").value.toLowerCase();
    const table = document.getElementById("claimTable");
    table.innerHTML = "";
    claimData.filter(c =>
      c.orderId.toLowerCase().includes(keyword) ||
      (c.reason && c.reason.toLowerCase().includes(keyword))
    ).forEach(item => {
      table.innerHTML += `
        <tr>
          <td class="border px-2 py-1">${item.orderId}</td>
          <td class="border px-2 py-1">${item.reason || "-"}</td>
          <td class="border px-2 py-1">${item.status || "-"}</td>
          
          <td class="border px-2 py-1">${item.claimedAtFormatted || "-"}</td>
          
          <td class="border px-2 py-1">
            <select id="status-${item.id}" class="border rounded px-1 py-0.5 text-sm bg-gray-50">
              <option${item.status === '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? ' selected' : ''}>‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
              <option${item.status === '‡πÄ‡∏Ñ‡∏•‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' ? ' selected' : ''}>‡πÄ‡∏Ñ‡∏•‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>
              <option${item.status === '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' ? ' selected' : ''}>‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
            </select>
            <button onclick="updateStatus('${item.id}')" class="ml-1 bg-blue-100 hover:bg-blue-200 text-blue-800 px-2 py-0.5 rounded text-sm">‚úî</button>
          </td>
          <td class="border px-2 py-1">${renderSource(item.source)}</td>
          <td class="border px-2 py-1 text-center">
  <button onclick='showDetail(${JSON.stringify(item).replace(/"/g, '&quot;')})' class="text-blue-600 hover:text-blue-800 text-lg">
    <i class="fas fa-eye"></i>
  </button>
</td>
<td class="border px-2 py-1 text-center">
  <button onclick="deleteClaim('${item.id}')" class="text-red-600 hover:text-red-800 text-lg">
    <i class="fas fa-trash-alt"></i>
  </button>
</td>

        </tr>`;
    });
  }

  document.getElementById("searchRegistration").addEventListener("input", renderRegistrationTable);
  document.getElementById("searchClaim").addEventListener("input", renderClaimTable);

  window.updateStatus = async (id) => {
    const status = document.getElementById(`status-${id}`).value;
    await fetch(`https://warranty-api-umg2.onrender.com/api/claims/${id}/status`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ status })
    });
    await fetch("https://warranty-api-umg2.onrender.com/api/notify-status-change", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ claimId: id, status })
    });
    document.getElementById("status").innerText = "‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
    loadClaims();
  };

  window.deleteRegistration = async (orderId) => {
    if (confirm("‚ö†Ô∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?")) {
      await fetch(`https://warranty-api-umg2.onrender.com/api/registrations/${orderId}`, { method: "DELETE" });
      loadRegistrations();
    }
  };

  window.deleteClaim = async (id) => {
    if (confirm("‚ö†Ô∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?")) {
      await fetch(`https://warranty-api-umg2.onrender.com/api/claims/${id}`, { method: "DELETE" });
      loadClaims();
    }
  };

  window.showDetail = (data) => {
  const modal = document.getElementById("detailModal");
  const content = document.getElementById("modalContent");

  const address = data.address && typeof data.address === "object"
    ? [data.address.line, data.address.subDistrict, data.address.district, data.address.province, data.address.postcode].filter(v => !!v).join(", ")
    : data.address || "-";

  const userId = data.userId && data.userId.length > 20 ? `${data.userId.slice(0, 10)}...` : data.userId || "-";

  const isClaim = !!data.claimedAt; // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ claimedAt ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏Ñ‡∏•‡∏°

  if (isClaim) {
  content.innerHTML = `
    <div><strong>orderId</strong>: ${data.orderId}</div>
    <div><strong>‡∏ä‡∏∑‡πà‡∏≠</strong>: ${data.name || "-"}</div>
    <div><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå</strong>: ${data.phone || "-"}</div>
    <div><strong>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</strong>: ${data.email || "-"}</div>
    <div><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</strong>: ${address}</div>
    <div><strong>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠</strong>: ${formatDate(data.registeredAt)}</div>
    <div><strong>‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</strong>: ${data.warrantyUntil || "-"}</div>
    <div><strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</strong>: ${data.reason || "-"}</div>
    <div><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</strong>: ${data.status || "-"}</div>
    <div><strong>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Ñ‡∏•‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠</strong>: ${formatDate(data.claimedAt)}</div>
  `;
}
else {
    // üëâ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    content.innerHTML = `
      <div><strong>orderId</strong>: ${data.orderId}</div>
      <div><strong>name</strong>: ${data.name || "-"}</div>
      <div><strong>phone</strong>: ${data.phone || "-"}</div>
      <div><strong>email</strong>: ${data.email || "-"}</div>
      <div><strong>userId</strong>: ${userId}</div>
      <div><strong>address</strong>: ${address}</div>
      <div><strong>registeredAt</strong>: ${formatDate(data.registeredAt)}</div>
      <div><strong>warrantyUntil</strong>: ${data.warrantyUntil || "-"}</div>
    `;
  }

  modal.classList.remove("hidden");
  modal.classList.add("flex");
};



  window.closeModal = () => {
    const modal = document.getElementById("detailModal");
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  };

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô export
window.exportToExcel = () => {
  const rows = [['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó', 'Order ID', '‡∏ä‡∏∑‡πà‡∏≠', '‡πÄ‡∏ö‡∏≠‡∏£‡πå', '‡∏≠‡∏µ‡πÄ‡∏°‡∏•', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•']];
  registrationData.forEach(r => rows.push([
    '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô',
    r.orderId,
    r.name,
    r.phone,
    r.email || '',
    formatDate(r.registeredAt),
    r.warrantyUntil || '',
    '-',
    '-'
  ]));
  claimData.forEach(c => rows.push([
    '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Ñ‡∏•‡∏°',
    c.orderId,
    '-',
    '-',
    '-',
    formatDate(c.claimedAt),
    '-',
    c.status || '',
    c.reason || ''
  ]));

  const ws = XLSX.utils.aoa_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô");

  const filename = `warranty-dashboard-${new Date().toISOString().split('T')[0]}.xlsx`;
  XLSX.writeFile(wb, filename);
};


</script>

</body>
</html>
