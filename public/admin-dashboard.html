<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4 font-sans">

  <div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold text-green-700">üìä Admin Dashboard</h1>
      <div id="admin-info" class="text-sm text-gray-600"></div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô -->
      <div>
        <h2 class="text-lg font-semibold mb-2">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
        <table class="w-full text-sm border border-gray-300 bg-white">
          <thead class="bg-gray-100">
            <tr>
              <th class="border px-2 py-1">Order ID</th>
              <th class="border px-2 py-1">‡∏ä‡∏∑‡πà‡∏≠</th>
              <th class="border px-2 py-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
              <th class="border px-2 py-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
              <th class="border px-2 py-1">‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</th>
              <th class="border px-2 py-1">‡∏•‡∏ö</th>
            </tr>
          </thead>
          <tbody id="registrationTable"></tbody>
        </table>
      </div>

      <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏° -->
      <div>
        <h2 class="text-lg font-semibold mb-2">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Ñ‡∏•‡∏°</h2>
        <table class="w-full text-sm border border-gray-300 bg-white">
          <thead class="bg-gray-100">
            <tr>
              <th class="border px-2 py-1">Order ID</th>
              <th class="border px-2 py-1">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</th>
              <th class="border px-2 py-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th class="border px-2 py-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
              <th class="border px-2 py-1">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th class="border px-2 py-1">‡∏•‡∏ö</th>
            </tr>
          </thead>
          <tbody id="claimTable"></tbody>
        </table>
      </div>
    </div>

    <p id="status" class="mt-4 text-center text-blue-600"></p>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

    // üîê ‡πÇ‡∏´‡∏•‡∏î config ‡∏à‡∏≤‡∏Å backend
    const res = await fetch("https://warranty-api-umg2.onrender.com/api/firebase-config");
    const firebaseConfig = await res.json();
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // ‚úÖ ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ
    const allowedAdmins = ["suphatraprayurkha@gmail.com"];

    // üîê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "admin-login.html";
      } else if (!allowedAdmins.includes(user.email)) {
        alert("‚õî ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ");
        signOut(auth);
      } else {
        document.getElementById("admin-info").innerHTML = `
          üë§ ${user.email}
          <button onclick="logout()" class="text-red-500 ml-2 underline">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        `;
        loadRegistrations();
        loadClaims();
      }
    });

    // üîª ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô logout
    window.logout = () => signOut(auth);

    // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
    async function loadRegistrations() {
      const res = await fetch("https://warranty-api-umg2.onrender.com/api/registrations");
      const data = await res.json();
      const table = document.getElementById("registrationTable");
      table.innerHTML = "";
      data.registrations.forEach(item => {
        const date = formatDate(item.registeredAt);
        table.innerHTML += `
          <tr>
            <td class="border px-2 py-1">${item.orderId}</td>
            <td class="border px-2 py-1">${item.name}</td>
            <td class="border px-2 py-1">${item.phone}</td>
            <td class="border px-2 py-1">${date}</td>
            <td class="border px-2 py-1">${item.warrantyUntil}</td>
            <td class="border px-2 py-1">
              <button onclick="deleteRegistration('${item.orderId}')" class="text-red-600">üóëÔ∏è</button>
            </td>
          </tr>`;
      });
    }

    // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏°
    async function loadClaims() {
      const res = await fetch("https://warranty-api-umg2.onrender.com/api/claims");
      const data = await res.json();
      const table = document.getElementById("claimTable");
      table.innerHTML = "";
      data.claims.forEach(item => {
        const date = formatDate(item.claimedAt);
        table.innerHTML += `
          <tr>
            <td class="border px-2 py-1">${item.orderId}</td>
            <td class="border px-2 py-1">${item.reason}</td>
            <td class="border px-2 py-1">${item.status}</td>
            <td class="border px-2 py-1">${date}</td>
            <td class="border px-2 py-1">
              <select id="status-${item.id}" class="border rounded px-1 py-0.5 text-sm">
                <option${item.status === '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? ' selected' : ''}>‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                <option${item.status === '‡πÄ‡∏Ñ‡∏•‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' ? ' selected' : ''}>‡πÄ‡∏Ñ‡∏•‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>
                <option${item.status === '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' ? ' selected' : ''}>‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
              </select>
              <button onclick="updateStatus('${item.id}')" class="ml-1 text-blue-600">‚úî</button>
            </td>
            <td class="border px-2 py-1">
              <button onclick="deleteClaim('${item.id}')" class="text-red-600">üóëÔ∏è</button>
            </td>
          </tr>`;
      });
    }

    // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏°
    async function updateStatus(claimId) {
      const newStatus = document.getElementById(`status-${claimId}`).value;
      const res = await fetch(`https://warranty-api-umg2.onrender.com/api/claims/${claimId}/status`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: newStatus })
      });
      const result = await res.json();
      document.getElementById("status").innerText = result.message || "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß";
      loadClaims();
    }

    // ‚úÖ ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏°
    async function deleteClaim(id) {
      if (!confirm("‚ö†Ô∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏°‡∏ô‡∏µ‡πâ?")) return;
      const res = await fetch(`https://warranty-api-umg2.onrender.com/api/claims/${id}`, { method: "DELETE" });
      const result = await res.json();
      document.getElementById("status").innerText = result.message || "‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß";
      loadClaims();
    }

    // ‚úÖ ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
    async function deleteRegistration(orderId) {
      if (!confirm("‚ö†Ô∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ?")) return;
      const res = await fetch(`https://warranty-api-umg2.onrender.com/api/registrations/${orderId}`, { method: "DELETE" });
      const result = await res.json();
      document.getElementById("status").innerText = result.message || "‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß";
      loadRegistrations();
    }

    // ‚úÖ format ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
    function formatDate(fbTimestamp) {
      try {
        const d = fbTimestamp.seconds ? new Date(fbTimestamp.seconds * 1000) : new Date(fbTimestamp);
        return d.toISOString().split("T")[0];
      } catch {
        return "-";
      }
    }
  </script>
  <script>
  // üîÑ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏•‡∏°
  async function updateStatus(claimId, newStatus) {
    try {
      const res = await fetch(`https://warranty-api-umg2.onrender.com/api/claims/${claimId}/status`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ status: newStatus })
      });

      if (!res.ok) throw new Error("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      alert("‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      location.reload();
    } catch (err) {
      alert("‚ùå ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      console.error(err);
    }
  }

  // üóëÔ∏è ‡∏•‡∏ö‡πÄ‡∏Ñ‡∏•‡∏°
  async function deleteClaim(claimId) {
    if (!confirm("‚ùó ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) return;

    try {
      const res = await fetch(`https://warranty-api-umg2.onrender.com/api/claims/${claimId}`, {
        method: "DELETE"
      });

      if (!res.ok) throw new Error("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      alert("‚úÖ ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      location.reload();
    } catch (err) {
      alert("‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      console.error(err);
    }
  }

  // üóëÔ∏è ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
  async function deleteRegistration(orderId) {
    if (!confirm("‚ùó ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) return;

    try {
      const res = await fetch(`https://warranty-api-umg2.onrender.com/api/registrations/${orderId}`, {
        method: "DELETE"
      });

      if (!res.ok) throw new Error("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      alert("‚úÖ ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      location.reload();
    } catch (err) {
      alert("‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      console.error(err);
    }
  }
</script>

</body>
</html>
