<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --admin-red: #ff0000;
      --admin-black: #121212;
      --admin-green: #00b140;
      --admin-light: #f7f7f7;
    }
  </style>
</head>
<body class="bg-[var(--admin-light)] p-8 font-sans text-black">

  <!-- üîù Navbar -->
  <nav class="bg-[var(--admin-green)] text-white px-6 py-3 rounded-xl max-w-6xl mx-auto mb-6 flex justify-between items-center shadow-lg">
   <div class="text-lg font-bold text-[var(--admin-light)]">üì¶ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</div>
    <div class="space-x-4 text-sm">
      <a href="admin-dashboard.html" class="bg-[var(--admin-red)] text-white px-3 py-1 rounded shadow">üìä Dashboard</a>
      <a href="admin-claims.html" class="hover:text-[var(--admin-red)]">üìã ‡πÄ‡∏Ñ‡∏•‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a>
      <a href="admin-registrations.html" class="hover:text-[var(--admin-red)]">‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</a>
      <a href="admin-upload.html"
       class="bg-white text-[#ee4d2d] border border-[#ee4d2d] hover:bg-[#ee4d2d] hover:text-white px-3 py-1 rounded shadow transition-all duration-200">
      üì§ Shopee
    </a>
    <a href="admin-upload-tiktok.html" class="bg-white text-[#ee4d2d] border border-[#ee4d2d] hover:bg-[#fe2c55] hover:text-white px-3 py-1 rounded shadow transition-all duration-200">üì§ TikTok</a>
    </div>
  </nav>

  <!-- üßæ Main -->
  <div class="max-w-6xl mx-auto">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold text-green-700">üìä Admin Dashboard</h1>
      <div id="admin-info" class="text-sm text-gray-600"></div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- ‚úÖ Registration Table -->
      <div class="bg-white p-4 rounded-xl shadow-md">
  <h2 class="text-black font-semibold mb-2">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
  <input type="text" id="searchRegistration" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Order ID, ‡∏ä‡∏∑‡πà‡∏≠, ‡πÄ‡∏ö‡∏≠‡∏£‡πå..." class="mb-2 w-full border px-3 py-1 rounded">

  <div class="overflow-x-auto max-h-[400px] overflow-y-auto border border-gray-200 rounded-md">
    <table class="w-full text-sm bg-white min-w-[600px]">
      <thead class="bg-gray-100 sticky top-0 z-10 text-left">
        <tr>
          <th class="border px-2 py-1">Order ID</th>
          <th class="border px-2 py-1">‡∏ä‡∏∑‡πà‡∏≠</th>
          <th class="border px-2 py-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
          <th class="border px-2 py-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
          <th class="border px-2 py-1">‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</th>
          <th class="border px-2 py-1">‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤</th>
          <th class="border px-2 py-1 text-center">‡∏î‡∏π</th>
          <th class="border px-2 py-1 text-center">‡∏•‡∏ö</th>
        </tr>
      </thead>
      <tbody id="registrationTable"></tbody>
    </table>
  </div>
</div>


      <!-- üìù Claim Table -->
      <div class="bg-white p-4 rounded-xl shadow-md">
  <h2 class="text-black font-semibold mb-2">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Ñ‡∏•‡∏°</h2>
  <input type="text" id="searchClaim" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Order ID, ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•..." class="mb-2 w-full border px-3 py-1 rounded">

  <div class="overflow-x-auto max-h-[400px] overflow-y-auto border border-gray-200 rounded-md">
    <table class="w-full text-sm bg-white min-w-[700px]">
      <thead class="bg-gray-100 sticky top-0 z-10 text-left">
        <tr>
          <th class="border px-2 py-1">Order ID</th>
          <th class="border px-2 py-1">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</th>
          <th class="border px-2 py-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th class="border px-2 py-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
          <th class="border px-2 py-1">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th class="border px-2 py-1">‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤</th>
          <th class="border px-2 py-1 text-center">‡∏î‡∏π</th>
          <th class="border px-2 py-1 text-center">‡∏•‡∏ö</th>
        </tr>
      </thead>
      <tbody id="claimTable"></tbody>
    </table>
  </div>
</div>


    <p id="status" class="mt-4 text-center text-blue-600"></p>
  </div>

  <!-- üîç Modal ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î -->
  <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-lg relative">
      <button onclick="closeModal()" class="absolute top-2 right-3 text-gray-500 hover:text-red-500 text-xl">‚úñ</button>
      <h3 class="text-lg font-semibold mb-4 text-green-600">üìÑ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h3>
      <div id="modalContent" class="text-sm space-y-2"></div>
    </div>
  </div>

  <!-- üì§ Export Button -->
  <div class="fixed bottom-4 right-4">
  <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow">‚¨áÔ∏è Export Excel</button>
</div>

  <script>
    function exportToExcel() {
    const rows = [['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó', 'Order ID', '‡∏ä‡∏∑‡πà‡∏≠', '‡πÄ‡∏ö‡∏≠‡∏£‡πå', '‡∏≠‡∏µ‡πÄ‡∏°‡∏•', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•']];
    registrationData.forEach(r => rows.push([
      '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô',
      r.orderId,
      r.name,
      r.phone,
      r.email || '',
      formatDate(r.registeredAt),
      r.warrantyUntil || '',
      '-',
      '-'
    ]));
    claimData.forEach(c => rows.push([
      '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Ñ‡∏•‡∏°',
      c.orderId,
      '-',
      '-',
      '-',
      formatDate(c.claimedAt),
      '-',
      c.status || '',
      c.reason || ''
    ]));

    const ws = XLSX.utils.aoa_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô");

    const filename = `warranty-dashboard-${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, filename);
  }
    
  </script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

  const firebaseRes = await fetch("https://warranty-api-umg2.onrender.com/api/firebase-config");
  const firebaseConfig = await firebaseRes.json();
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const allowedAdmins = ["suphatraprayurkha@gmail.com"];

  let registrationData = [], claimData = [];

  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = "admin-login.html";
    } else if (!allowedAdmins.includes(user.email)) {
      alert("‚õî ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ");
      signOut(auth);
    } else {
      document.getElementById("admin-info").innerHTML = `üë§ ${user.email} <button onclick="logout()" class="text-red-500 ml-2 underline">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>`;
      loadRegistrations();
      loadClaims();
    }
  });

  window.logout = () => signOut(auth);

  async function loadRegistrations() {
    const res = await fetch("https://warranty-api-umg2.onrender.com/api/registrations");
    const data = await res.json();
    registrationData = data.registrations;
    renderRegistrationTable();
  }

  async function loadClaims() {
    const res = await fetch("https://warranty-api-umg2.onrender.com/api/claims");
    const data = await res.json();
    claimData = data.claims;
    renderClaimTable();
  }

  function formatDate(ts) {
  try {
    if (!ts) return "-";

    if (typeof ts === "string") {
      const date = new Date(ts);
      return isNaN(date.getTime()) ? "-" : date.toISOString().split("T")[0];
    }

    if (typeof ts === "object") {
      // Firestore Timestamp JSON
      if ("seconds" in ts) {
        return new Date(ts.seconds * 1000).toISOString().split("T")[0];
      }

      // Timestamp ‡∏ó‡∏µ‡πà‡∏°‡∏µ .toDate()
      if (typeof ts.toDate === "function") {
        return ts.toDate().toISOString().split("T")[0];
      }
    }

    return "-";
  } catch {
    return "-";
  }
}

function renderSource(source) {
  if (source === "tiktok") {
    return `<span class="bg-black text-white text-xs px-2 py-0.5 rounded">TikTok</span>`;
  } else if (source === "shopee") {
    return `<span class="bg-orange-500 text-white text-xs px-2 py-0.5 rounded">Shopee</span>`;
  } else {
    return `<span class="bg-gray-300 text-gray-700 text-xs px-2 py-0.5 rounded">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</span>`;
  }
}





  function renderRegistrationTable() {
    const keyword = document.getElementById("searchRegistration").value.toLowerCase();
    const table = document.getElementById("registrationTable");
    table.innerHTML = "";
    registrationData.filter(r =>
      r.orderId.toLowerCase().includes(keyword) ||
      (r.name && r.name.toLowerCase().includes(keyword)) ||
      (r.phone && r.phone.includes(keyword))
    ).forEach(item => {
      table.innerHTML += `
        <tr>
          <td class="border px-2 py-1">${item.orderId}</td>
          <td class="border px-2 py-1">${item.name || "-"}</td>
          <td class="border px-2 py-1">${item.phone || "-"}</td>
          
          <td class="border px-2 py-1">${item.registeredAtFormatted || "-"}</td>

          <td class="border px-2 py-1">${item.warrantyUntil || "-"}</td>
          <td class="border px-2 py-1">${renderSource(item.source)}</td>

          <td class="border px-2 py-1 text-center">
            <button onclick='showDetail(${JSON.stringify(item).replace(/"/g, '&quot;')})' class="text-blue-600 hover:underline">üëÅ</button>
          </td>
          <td class="border px-2 py-1 text-center">
            <button onclick="deleteRegistration('${item.orderId}')" class="text-red-600 hover:underline">üóë</button>
          </td>
        </tr>`;
    });
  }

  function renderClaimTable() {
    const keyword = document.getElementById("searchClaim").value.toLowerCase();
    const table = document.getElementById("claimTable");
    table.innerHTML = "";
    claimData.filter(c =>
      c.orderId.toLowerCase().includes(keyword) ||
      (c.reason && c.reason.toLowerCase().includes(keyword))
    ).forEach(item => {
      table.innerHTML += `
        <tr>
          <td class="border px-2 py-1">${item.orderId}</td>
          <td class="border px-2 py-1">${item.reason || "-"}</td>
          <td class="border px-2 py-1">${item.status || "-"}</td>
          
          <td class="border px-2 py-1">${item.claimedAtFormatted || "-"}</td>
          
          <td class="border px-2 py-1">
            <select id="status-${item.id}" class="border rounded px-1 py-0.5 text-sm bg-gray-50">
              <option${item.status === '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? ' selected' : ''}>‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
              <option${item.status === '‡πÄ‡∏Ñ‡∏•‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' ? ' selected' : ''}>‡πÄ‡∏Ñ‡∏•‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>
              <option${item.status === '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' ? ' selected' : ''}>‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
            </select>
            <button onclick="updateStatus('${item.id}')" class="ml-1 bg-blue-100 hover:bg-blue-200 text-blue-800 px-2 py-0.5 rounded text-sm">‚úî</button>
          </td>
          <td class="border px-2 py-1">${renderSource(item.source)}</td>
          <td class="border px-2 py-1 text-center">
            <button onclick='showDetail(${JSON.stringify(item).replace(/"/g, '&quot;')})' class="text-blue-600 hover:underline">üëÅ</button>
          </td>
          <td class="border px-2 py-1 text-center">
            <button onclick="deleteClaim('${item.id}')" class="text-red-600 hover:underline">üóë</button>
          </td>
        </tr>`;
    });
  }

  document.getElementById("searchRegistration").addEventListener("input", renderRegistrationTable);
  document.getElementById("searchClaim").addEventListener("input", renderClaimTable);

  window.updateStatus = async (id) => {
    const status = document.getElementById(`status-${id}`).value;
    await fetch(`https://warranty-api-umg2.onrender.com/api/claims/${id}/status`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ status })
    });
    await fetch("https://warranty-api-umg2.onrender.com/api/notify-status-change", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ claimId: id, status })
    });
    document.getElementById("status").innerText = "‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
    loadClaims();
  };

  window.deleteRegistration = async (orderId) => {
    if (confirm("‚ö†Ô∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?")) {
      await fetch(`https://warranty-api-umg2.onrender.com/api/registrations/${orderId}`, { method: "DELETE" });
      loadRegistrations();
    }
  };

  window.deleteClaim = async (id) => {
    if (confirm("‚ö†Ô∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?")) {
      await fetch(`https://warranty-api-umg2.onrender.com/api/claims/${id}`, { method: "DELETE" });
      loadClaims();
    }
  };

  window.showDetail = (data) => {
  const modal = document.getElementById("detailModal");
  const content = document.getElementById("modalContent");

  // ‚úÖ ‡πÅ‡∏õ‡∏•‡∏á address ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢
  const address =
  data.address && typeof data.address === "object"
    ? [
        data.address.line,
        data.address.subDistrict,
        data.address.district,
        data.address.province,
        data.address.postcode,
      ]
        .filter((v) => !!v)
        .join(", ")
    : data.address || "-";


  // ‚úÖ ‡∏ï‡∏±‡∏î userId ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏™‡∏±‡πâ‡∏ô
  const userId =
    data.userId && data.userId.length > 20
      ? `${data.userId.slice(0, 10)}...`
      : data.userId || "-";

  // ‚úÖ registeredAt ‚Üí format ‡∏´‡∏£‡∏∑‡∏≠ "-"
  const registeredAt = data.registeredAt
    ? formatDate(data.registeredAt)
    : "-";

  content.innerHTML = `
    <div><strong>orderId</strong>: ${data.orderId}</div>
    <div><strong>name</strong>: ${data.name || "-"}</div>
    <div><strong>phone</strong>: ${data.phone || "-"}</div>
    <div><strong>email</strong>: ${data.email || "-"}</div>
    <div><strong>userId</strong>: ${userId}</div>
    <div><strong>address</strong>: ${address}</div>
    <div><strong>registeredAt</strong>: ${registeredAt}</div>
    <div><strong>warrantyUntil</strong>: ${data.warrantyUntil || "-"}</div>
    <div><strong>status</strong>: ${data.status || "-"}</div>
    <div><strong>reason</strong>: ${data.reason || "-"}</div>
  `;
  modal.classList.remove("hidden");
  modal.classList.add("flex");
};


  window.closeModal = () => {
    const modal = document.getElementById("detailModal");
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  };
</script>

</body>
</html>
